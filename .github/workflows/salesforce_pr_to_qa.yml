
# 1) Checkout repo (default branch)
- uses: actions/checkout@v4
  with:
    fetch-depth: 0
# docs: fetch-depth 0 gets full history; ref defaults to the event ref. [9](https://github.com/actions/checkout)

# 2) Verify remote feature/base branches exist, fetch remote feature tip
- name: Verify & fetch remote feature/base branches
  shell: bash
  run: |
    set -euxo pipefail
    FEATURE="${{ github.event.client_payload.branch }}"
    BASE="${{ github.event.client_payload.baseRef || 'qa' }}"
    git ls-remote --exit-code --heads origin "$FEATURE"
    git ls-remote --exit-code --heads origin "$BASE"
    git fetch --no-tags --prune origin "$FEATURE":"refs/remotes/origin/$FEATURE"

# 3) Create dup branch from origin/<feature> tip
- name: Create and push duplicate branch
  env:
    FEATURE: ${{ github.event.client_payload.branch }}
    DUP_BRANCH: ${{ steps.vars.outputs.dup_branch }}
  shell: bash
  run: |
    set -euxo pipefail
    git config user.name "github-actions[bot]"
    git config user.email "actions@users.noreply.github.com"
    git checkout -B "$DUP_BRANCH" "origin/$FEATURE"
    # optional marker commit to ensure push updates ref
    echo "Source: $FEATURE" > DUP_INFO.md
    git add DUP_INFO.md || true
    git commit -m "chore: duplicate $FEATURE -> $DUP_BRANCH" || true
    git push -u origin "$DUP_BRANCH"
