
name: Create PR to QA (duplicate feature branch via REST)

on:
  repository_dispatch:
    types: [salesforce_pr_to_qa]
  workflow_dispatch:
    inputs:
      branch:
        description: 'Feature branch to duplicate (e.g., feature/abc-123)'
        required: true
      baseRef:
        description: 'Base branch for PR'
        required: false
        default: 'qa'
      workItemId:
        description: 'Salesforce WorkItem Id'
        required: false
      jiraUrl:
        description: 'Jira URL'
        required: false
      details:
        description: 'Work item details'
        required: false

permissions:
  contents: write
  pull-requests: write

jobs:
  duplicate-and-pr:
    runs-on: ubuntu-latest
    concurrency:
      group: pr-to-qa-${{ github.event.client_payload.branch || inputs.branch }}
      cancel-in-progress: false

    steps:
      # 1) Resolve inputs and validate source pattern feature/*
      - name: Resolve inputs
        id: inp
        shell: bash
        run: |
          set -euo pipefail
          BRANCH="${{ github.event.client_payload.branch || inputs.branch }}"
          # Normalize refs/heads/* prefix if present
          BRANCH="${BRANCH#refs/heads/}"

          # Enforce the required pattern: feature/*
          if [[ -z "${BRANCH}" ]]; then
            echo "Feature branch is required." >&2
            exit 1
          fi
          if [[ "${BRANCH}" != feature/* ]]; then
            echo "Invalid source branch '${BRANCH}'. Expected pattern: feature/*" >&2
            echo "Tip: provide e.g. 'feature/abc-123'." >&2
            exit 1
          fi

          BASE="${{ github.event.client_payload.baseRef || inputs.baseRef || 'qa' }}"
          WI="${{ github.event.client_payload.workItemId || inputs.workItemId }}"
          JIRA="${{ github.event.client_payload.jiraUrl || inputs.jiraUrl }}"
          DETAILS="${{ github.event.client_payload.details || inputs.details }}"

          echo "branch=${BRANCH}"   >> "$GITHUB_OUTPUT"
          echo "base=${BASE}"       >> "$GITHUB_OUTPUT"
          echo "workItemId=${WI}"   >> "$GITHUB_OUTPUT"
          echo "jiraUrl=${JIRA}"    >> "$GITHUB_OUTPUT"
          echo "details=${DETAILS}" >> "$GITHUB_OUTPUT"

      # 2) Compute dup_feature/* safely from tail of feature/*
      - name: Compute dup branch name
        id: vars
        shell: bash
        run: |
          set -euo pipefail
          FEATURE="${{ steps.inp.outputs.branch }}"
          TAIL="${FEATURE##*/}"  # feature/abc-123 -> abc-123

          # Build a safe slug for Git ref:
          # - keep only a-z 0-9 - _
          # - lowercase
          # - collapse multiple dashes/underscores
          # - trim leading/trailing dashes/underscores
          # - fallback to 'unnamed' if empty
          SAFE="$(echo "$TAIL" \
            | tr '[:upper:]' '[:lower:]' \
            | tr -cd '[:alnum:]-_' \
            | sed -E 's/[-_]+/-/g' \
            | sed -E 's/^[-_]+//; s/[-_]+$//' \
          )"

          if [[ -z "$SAFE" ]]; then
            SAFE="unnamed"
          fi

          # Limit to 64 chars to avoid overly long refs
          SAFE="${SAFE:0:64}"

          DUP="dup_feature/${SAFE}"
          echo "dup_branch=${DUP}" >> "$GITHUB_OUTPUT"
          echo "Duplicate branch will be: ${DUP}"

      # 3) Create duplicate branch via REST (points at feature/* SHA)
      - name: Create duplicate branch ref (or confirm it exists)
        id: createref
        uses: actions/github-script@v7
        env:
          FEATURE: ${{ steps.inp.outputs.branch }}
          DUP: ${{ steps.vars.outputs.dup_branch }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const featureRef = `heads/${process.env.FEATURE}`;
            const dupRefFull = `refs/heads/${process.env.DUP}`;

            // Get source SHA from feature/*
            const featureHeads = await github.rest.git.getRef({ owner, repo, ref: featureRef });
            const sha = featureHeads.data.object.sha;
            core.info(`Feature ref: ${featureHeads.data.ref} -> ${sha}`);

            // Check if dup_feature/* exists
            let dupExists = false;
            try {
              const dupHeads = await github.rest.git.getRef({ owner, repo, ref: `heads/${process.env.DUP}` });
              dupExists = !!dupHeads?.data?.ref;
              core.info(`Duplicate branch already exists: ${dupHeads.data.ref}`);
              core.setOutput('dup_exists', 'true');
            } catch {
              core.info(`Duplicate branch does not exist yet; will create it.`);
              core.setOutput('dup_exists', 'false');
            }

            // Create if missing
            if (!dupExists) {
              await github.rest.git.createRef({ owner, repo, ref: dupRefFull, sha });
              core.info(`Created duplicate branch ref: ${dupRefFull} -> ${sha}`);
            }

      # 4) Verify base branch exists
      - name: Verify base branch exists (QA)
        uses: actions/github-script@v7
        env:
          BASE: ${{ steps.inp.outputs.base }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const base = process.env.BASE;
            try {
              const baseRef = await github.rest.git.getRef({ owner, repo, ref: `heads/${base}` });
              core.info(`Base branch found: ${baseRef.data.ref}`);
            } catch (e) {
              core.setFailed(`Base branch '${base}' not found on origin.`);
            }

      # 5) Find existing PR dup_feature/* -> base (avoid duplicates)
      - name: Find existing PR dup_feature -> base
        id: findpr
        uses: actions/github-script@v7
        env:
          DUP_BRANCH: ${{ steps.vars.outputs.dup_branch }}
          BASE: ${{ steps.inp.outputs.base }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const head = `${owner}:${process.env.DUP_BRANCH}`;
            const base = process.env.BASE;

            const { data: prs } = await github.rest.pulls.list({ owner, repo, state: 'open', head, base });
            if (prs.length > 0) {
              const pr = prs[0];
              core.info(`PR already exists: #${pr.number} (${pr.html_url})`);
              core.setOutput('exists', 'true');
              core.setOutput('number', String(pr.number));
              core.setOutput('url', pr.html_url);
            } else {
              core.setOutput('exists', 'false');
            }

      # 6) Create the PR if none exists
      - name: Create PR dup_feature -> base
        id: createpr
        if: steps.findpr.outputs.exists != 'true'
        uses: actions/github-script@v7
        env:
          DUP_BRANCH: ${{ steps.vars.outputs.dup_branch }}
          BASE: ${{ steps.inp.outputs.base }}
          FEATURE: ${{ steps.inp.outputs.branch }}
          WI: ${{ steps.inp.outputs.workItemId }}
          JIRA: ${{ steps.inp.outputs.jiraUrl }}
          DETAILS: ${{ steps.inp.outputs.details }}
        with:
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;

            const dup = process.env.DUP_BRANCH;
            const base = process.env.BASE;
            const title = `PR: ${dup} -> ${base}`;
            const body = [
              'Triggered by Salesforce',
              `Feature branch: ${process.env.FEATURE}`,
              `Duplicate branch: ${dup}`,
              `Base branch: ${base}`,
              process.env.WI ? `WorkItem: ${process.env.WI}` : '',
              process.env.JIRA ? `Jira: ${process.env.JIRA}` : '',
              process.env.DETAILS ? `Details: ${process.env.DETAILS}` : ''
            ].filter(Boolean).join('\n');

            const { data: pr } = await github.rest.pulls.create({
              owner, repo, title, head: dup, base, body
            });
            core.info(`Created PR #${pr.number}: ${pr.html_url}`);
            core.setOutput('number', String(pr.number));
            core.setOutput('url', pr.html_url);

      # 7) Export PR info for downstream steps (and FEATURE)
      - name: PR info
        shell: bash
        run: |
          set -euo pipefail
          if [ "${{ steps.findpr.outputs.exists }}" = "true" ]; then
            PR_URL="${{ steps.findpr.outputs.url }}"
            PR_NUM="${{ steps.findpr.outputs.number }}"
            echo "Existing PR #${PR_NUM} -> ${PR_URL}"
          else
            PR_URL="${{ steps.createpr.outputs.url }}"
            PR_NUM="${{ steps.createpr.outputs.number }}"
            echo "New PR #${PR_NUM} -> ${PR_URL}"
          fi
          echo "FEATURE=${{ steps.inp.outputs.branch }}" >> "$GITHUB_ENV"
          echo "PR_URL=${PR_URL}" >> "$GITHUB_ENV"
          echo "PR_NUM=${PR_NUM}" >> "$GITHUB_ENV"
          {
            echo "### QA PR"
            echo "- URL: ${PR_URL}"
            echo "- Number: ${PR_NUM}"
          } >> "$GITHUB_STEP_SUMMARY"

      # 8) Get Salesforce OAuth token (JWT Bearer)
      - name: Get Salesforce OAuth token (JWT Bearer)
        id: jwt
        shell: bash
        env:
          SF_CONSUMER_KEY: ${{ secrets.SF_CONSUMER_KEY }}
          SF_USERNAME:     ${{ secrets.SF_USERNAME }}
          SF_LOGIN_URL:    ${{ secrets.SF_LOGIN_URL }}
          SF_PRIVATE_KEY:  ${{ secrets.SF_PRIVATE_KEY }}
        run: |
          set -euo pipefail
          if [[ -z "${SF_CONSUMER_KEY}" || -z "${SF_USERNAME}" || -z "${SF_LOGIN_URL}" || -z "${SF_PRIVATE_KEY}" ]]; then
            echo "Missing one or more Salesforce JWT secrets (SF_CONSUMER_KEY/SF_USERNAME/SF_LOGIN_URL/SF_PRIVATE_KEY)" >&2
            exit 1
          fi

          echo "$SF_PRIVATE_KEY" > /tmp/sf_private_key.pem
          ISS="$SF_CONSUMER_KEY"
          SUB="$SF_USERNAME"
          AUD="$SF_LOGIN_URL"
          NOW=$(date +%s)
          EXP=$((NOW+300))

          HEADER=$(jq -nc --arg alg RS256 --arg typ JWT '{alg:$alg,typ:$typ}')
          CLAIMS=$(jq -nc --arg iss "$ISS" --arg sub "$SUB" --arg aud "$AUD" --argjson iat "$NOW" --argjson exp "$EXP" '{iss:$iss,sub:$sub,aud:$aud,iat:$iat,exp:$exp}')

          B64HDR=$(echo -n "$HEADER" | openssl base64 -A | tr '+/' '-_' | tr -d '=')
          B64CLM=$(echo -n "$CLAIMS" | openssl base64 -A | tr '+/' '-_' | tr -d '=')
          SIG=$(printf "%s.%s" "$B64HDR" "$B64CLM" | openssl dgst -sha256 -sign /tmp/sf_private_key.pem | openssl base64 -A | tr '+/' '-_' | tr -d '=')
          JWT="$B64HDR.$B64CLM.$SIG"

          RESP=$(curl -sS "$SF_LOGIN_URL/services/oauth2/token" \
            -d grant_type=urn:ietf:params:oauth:grant-type:jwt-bearer \
            --data-urlencode assertion="$JWT")
          ACCESS_TOKEN=$(echo "$RESP" | jq -r '.access_token')
          INSTANCE_URL=$(echo "$RESP" | jq -r '.instance_url')

          if [[ -z "$ACCESS_TOKEN" || -z "$INSTANCE_URL" || "$ACCESS_TOKEN" == "null" || "$INSTANCE_URL" == "null" ]]; then
            echo "Failed to obtain Salesforce token: $RESP" >&2
            exit 1
          fi

          echo "ACCESS_TOKEN=$ACCESS_TOKEN" >> $GITHUB_ENV
          echo "INSTANCE_URL=$INSTANCE_URL" >> $GITHUB_ENV

      # 9) Callback to Salesforce (create/update Pull_Request__c)
      - name: Callback to Salesforce (create/update Pull_Request__c)
        shell: bash
        env:
          ACCESS_TOKEN: ${{ env.ACCESS_TOKEN }}
          INSTANCE_URL: ${{ env.INSTANCE_URL }}
          WI:      ${{ steps.inp.outputs.workItemId }}
          FEATURE: ${{ env.FEATURE }}
          DUP:     ${{ steps.vars.outputs.dup_branch }}
          BASE:    ${{ steps.inp.outputs.base }}
          PR_URL:  ${{ env.PR_URL }}
          PR_NUM:  ${{ env.PR_NUM }}
        run: |
          set -euo pipefail
          if [[ -z "$PR_URL" || -z "$PR_NUM" ]]; then
            echo "No PR URL/Number found; skipping Salesforce callback." >&2
            exit 0
          fi

          BODY=$(jq -n \
            --arg wi "$WI" \
            --arg src "$FEATURE" \
            --arg tgt "$BASE" \
            --arg num "$PR_NUM" \
            --arg url "$PR_URL" \
            --arg stat "Open" \
            --arg dup "$DUP" \
            '{workItemId:$wi,sourceBranch:$src,targetBranch:$tgt,prNumber:$num,prUrl:$url,status:$stat,duplicateBranch:$dup}')

          HTTP_CODE=$(curl -sS -o /tmp/sf_resp.json -w '%{http_code}' \
            -X POST "$INSTANCE_URL/services/apexrest/github/pr-callback" \
            -H "Authorization: Bearer $ACCESS_TOKEN" \
            -H "Content-Type: application/json" \
            --data "$BODY")

          echo "Salesforce response code: $HTTP_CODE"
          sed -n '1,200p' /tmp/sf_resp.json || true

          if [[ "$HTTP_CODE" -lt 200 || "$HTTP_CODE" -ge 300 ]]; then
            echo "Salesforce callback failed with HTTP $HTTP_CODE" >&2
            exit 1
          fi
